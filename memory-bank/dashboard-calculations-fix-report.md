# Dashboard Calculations Fix Report

## Проблема
В роли регистратора все карточки показывали одинаковое количество заявок (32), что было неправильно. Логика расчета просроченных заявок была основана на дате создания (`createdAt`) вместо даты оплаты (`dueDate`).

## Анализ проблемы

### ✅ Обнаруженные ошибки:
1. **Неправильная логика просроченных заявок** - Использовалась дата создания вместо даты оплаты
2. **Неточный расчет времени** - Использовался период 5 часов вместо сравнения с текущей датой
3. **Дублирование ошибок** - Одинаковая логика была в нескольких местах кода

### ✅ Проблемные места:
- `getMetrics()` функция для всех ролей
- `getRecentRequests()` функция для фильтрации
- Логика расчета `overdueRequests` везде была одинаковой

## Решение

### ✅ 1. Исправление логики расчета просроченных заявок

**Старая логика (неправильная):**
```javascript
const fiveHoursAgo = new Date(Date.now() - 5 * 60 * 60 * 1000);
const overdueRequests = newRequests.filter(r => {
  try {
    const createdDate = new Date(r.createdAt);
    return !isNaN(createdDate.getTime()) && createdDate < fiveHoursAgo;
  } catch (error) {
    return false;
  }
});
```

**Новая логика (правильная):**
```javascript
const today = new Date();
today.setHours(0, 0, 0, 0); // Start of today
const overdueRequests = newRequests.filter(r => {
  try {
    const dueDate = new Date(r.dueDate);
    if (isNaN(dueDate.getTime())) {
      return false;
    }
    dueDate.setHours(0, 0, 0, 0); // Start of due date
    return dueDate < today;
  } catch (error) {
    return false;
  }
});
```

### ✅ 2. Исправленные роли

#### Registrar (Регистратор)
- **Всего заявок**: Все заявки со статусами `['submitted', 'classified', 'returned', 'declined']`
- **Новые заявки**: Заявки со статусом `'submitted'`
- **Зарегистрировано**: Заявки со статусом `'classified'`
- **Просрочено**: Заявки со статусом `'submitted'` и датой оплаты < сегодня
- **Возвращено на доработку**: Заявки со статусом `'returned'`
- **Отклонено**: Заявки со статусом `'declined'`

#### Distributor (Распорядитель)
- **Всего заявок**: Все заявки со статусами `['classified', 'approved', 'in-register', 'approved-for-payment', 'paid-full', 'paid-partial', 'declined', 'returned']`
- **Новые заявки**: Заявки со статусом `'classified'`
- **Просрочено**: Заявки со статусом `'classified'` и датой оплаты < сегодня

#### Treasurer (Казначей)
- **Всего заявок**: Все заявки со статусами `['approved', 'in-register', 'approved-for-payment', 'paid-full', 'paid-partial', 'declined', 'returned']`
- **Новые заявки**: Заявки со статусом `'approved'`
- **Просрочено**: Заявки со статусом `'approved'` и датой оплаты < сегодня

### ✅ 3. Исправленные функции

#### `getMetrics()` - Расчет метрик для карточек
- **Registrar**: Строки 99-112
- **Distributor**: Строки 142-155  
- **Treasurer**: Строки 213-226

#### `getRecentRequests()` - Фильтрация для списка заявок
- **Registrar**: Строки 322-339
- **Treasurer**: Строки 360-377

## Тестирование

### ✅ Создан тестовый скрипт
**Файл**: `test-dashboard-calculations.js`

**Тестовые данные**:
- 5 заявок с разными датами оплаты
- 4 заявки со статусом `'submitted'` (для регистратора)
- 1 заявка со статусом `'classified'` (для распорядителя)
- 0 заявок со статусом `'approved'` (для казначея)

**Результаты теста**:
```
Registrar role:
- Total submitted requests: 4
- Overdue requests: 2 (правильно - 2 заявки с просроченной датой)
- Overdue request IDs: [ '1', '5' ]

Distributor role:
- Total classified requests: 1
- Overdue requests: 1 (правильно - 1 заявка с просроченной датой)
- Overdue request IDs: [ '4' ]

Treasurer role:
- Total approved requests: 0
- Overdue requests: 0 (правильно - нет заявок)
- Overdue request IDs: []
```

## Результат

### ✅ Исправлено:
- **Правильный расчет просроченных заявок** - Основан на дате оплаты (`dueDate`)
- **Точные метрики для каждой роли** - Разные расчеты для разных ролей
- **Корректная фильтрация** - Список заявок фильтруется правильно
- **Устранено дублирование** - Одинаковая логика во всех местах

### ✅ Функциональность:
- **Карточки статистики** - Показывают правильные числа
- **Фильтр "Просрочено"** - Работает корректно
- **Список заявок** - Отображает правильные данные
- **Все роли** - Логика исправлена для всех ролей

## Технические детали

### ✅ Логика расчета:
1. **Получение текущей даты** - `new Date()` с обнулением времени
2. **Парсинг даты оплаты** - `new Date(r.dueDate)` с обнулением времени
3. **Сравнение дат** - `dueDate < today` для определения просрочки
4. **Обработка ошибок** - Проверка на `isNaN()` и try-catch

### ✅ Оптимизация:
- **Единая логика** - Одинаковый код во всех местах
- **Производительность** - Минимальные вычисления
- **Читаемость** - Понятные комментарии и структура

## Файлы изменены

### `frontend/src/components/Dashboard.tsx`
- **Строки 99-112**: Исправлена логика для регистратора
- **Строки 142-155**: Исправлена логика для распорядителя  
- **Строки 213-226**: Исправлена логика для казначея
- **Строки 322-339**: Исправлена фильтрация для регистратора
- **Строки 360-377**: Исправлена фильтрация для казначея

### Созданные файлы
- `test-dashboard-calculations.js` - Тестовый скрипт
- `dashboard-calculations-fix-report.md` - Отчет об исправлении

## Статус
✅ **ЗАВЕРШЕНО** - Логика расчетов исправлена для всех ролей

## Следующие шаги
1. Протестировать в браузере с реальными данными
2. Проверить работу фильтров
3. Убедиться, что статистические карточки показывают правильные данные
4. При необходимости добавить дополнительную валидацию дат
