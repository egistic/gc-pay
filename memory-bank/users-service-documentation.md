# Users Service Documentation

## Обзор

Сервис Users предоставляет полный функционал для управления пользователями и ролями в системе GC Spends. Сервис включает в себя CRUD операции для пользователей, управление ролями и назначение ролей пользователям.

## Архитектура

### Структура модуля
```
app/modules/users/
├── __init__.py          # Инициализация модуля
├── schemas.py           # Pydantic модели для валидации данных
├── router.py            # API endpoints для пользователей
└── roles_router.py      # API endpoints для ролей
```

### Зависимости
- **FastAPI** - веб-фреймворк
- **SQLAlchemy** - ORM для работы с базой данных
- **Pydantic** - валидация данных
- **UUID** - генерация уникальных идентификаторов
- **EmailStr** - валидация email адресов

## Модели данных

### UserCreate
Схема для создания нового пользователя.

```python
class UserCreate(BaseModel):
    full_name: str          # Полное имя пользователя
    email: EmailStr         # Email адрес (уникальный)
    phone: str | None       # Номер телефона (опционально)
    password: str           # Пароль (будет захеширован)
```

**Пример запроса:**
```json
{
    "full_name": "Иван Иванов",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 123 45 67",
    "password": "secure_password123"
}
```

### UserUpdate
Схема для обновления пользователя.

```python
class UserUpdate(BaseModel):
    full_name: str | None       # Полное имя (опционально)
    email: EmailStr | None      # Email адрес (опционально)
    phone: str | None           # Номер телефона (опционально)
    is_active: bool | None      # Статус активности (опционально)
```

**Пример запроса:**
```json
{
    "full_name": "Иван Петров",
    "phone": "+7 777 987 65 43",
    "is_active": true
}
```

### UserOut
Схема для возврата данных пользователя.

```python
class UserOut(BaseModel):
    id: uuid.UUID          # Уникальный идентификатор
    full_name: str         # Полное имя
    email: EmailStr        # Email адрес
    phone: str | None      # Номер телефона
    is_active: bool        # Статус активности
```

### RoleCreate
Схема для создания новой роли.

```python
class RoleCreate(BaseModel):
    code: str              # Код роли (уникальный)
    name: str              # Название роли
```

**Пример запроса:**
```json
{
    "code": "ADMIN",
    "name": "Администратор"
}
```

### RoleOut
Схема для возврата данных роли.

```python
class RoleOut(BaseModel):
    id: uuid.UUID          # Уникальный идентификатор
    code: str              # Код роли
    name: str              # Название роли
```

### UserRoleAssign
Схема для назначения роли пользователю.

```python
class UserRoleAssign(BaseModel):
    role_id: uuid.UUID     # ID роли
    valid_from: date       # Дата начала действия
    valid_to: date | None  # Дата окончания действия (опционально)
    is_primary: bool       # Основная ли роль (по умолчанию False)
```

**Пример запроса:**
```json
{
    "role_id": "123e4567-e89b-12d3-a456-426614174000",
    "valid_from": "2024-01-01",
    "valid_to": "2024-12-31",
    "is_primary": true
}
```

### UserWithRoles
Расширенная схема пользователя с ролями.

```python
class UserWithRoles(UserOut):
    roles: List[RoleOut]   # Список ролей пользователя
```

## API Endpoints

### Пользователи

#### 1. Создание пользователя
**POST** `/api/users`

Создает нового пользователя в системе.

**Запрос:**
```json
{
    "full_name": "Иван Иванов",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 123 45 67",
    "password": "secure_password123"
}
```

**Ответ (201):**
```json
{
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "full_name": "Иван Иванов",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 123 45 67",
    "is_active": true
}
```

**Ошибки:**
- `409 Conflict` - Email уже существует
- `422 Unprocessable Entity` - Ошибка валидации данных

#### 2. Получение списка пользователей
**GET** `/api/users`

Возвращает список всех пользователей в системе.

**Ответ (200):**
```json
[
    {
        "id": "123e4567-e89b-12d3-a456-426614174000",
        "full_name": "Иван Иванов",
        "email": "ivan.ivanov@example.com",
        "phone": "+7 777 123 45 67",
        "is_active": true
    }
]
```

#### 3. Получение пользователя по ID
**GET** `/api/users/{user_id}`

Возвращает данные пользователя с его ролями.

**Параметры:**
- `user_id` (UUID) - ID пользователя

**Ответ (200):**
```json
{
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "full_name": "Иван Иванов",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 123 45 67",
    "is_active": true,
    "roles": [
        {
            "id": "456e7890-e89b-12d3-a456-426614174001",
            "code": "EXECUTOR",
            "name": "Исполнитель"
        }
    ]
}
```

**Ошибки:**
- `404 Not Found` - Пользователь не найден

#### 4. Обновление пользователя
**PUT** `/api/users/{user_id}`

Обновляет данные пользователя.

**Параметры:**
- `user_id` (UUID) - ID пользователя

**Запрос:**
```json
{
    "full_name": "Иван Петров",
    "phone": "+7 777 987 65 43",
    "is_active": true
}
```

**Ответ (200):**
```json
{
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "full_name": "Иван Петров",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 987 65 43",
    "is_active": true
}
```

**Ошибки:**
- `404 Not Found` - Пользователь не найден
- `409 Conflict` - Email уже используется другим пользователем

#### 5. Удаление пользователя
**DELETE** `/api/users/{user_id}`

Удаляет пользователя из системы.

**Параметры:**
- `user_id` (UUID) - ID пользователя

**Ответ (204):** Пустой ответ

**Ошибки:**
- `404 Not Found` - Пользователь не найден

#### 6. Назначение роли пользователю
**POST** `/api/users/{user_id}/roles`

Назначает роль пользователю с указанием периода действия.

**Параметры:**
- `user_id` (UUID) - ID пользователя

**Запрос:**
```json
{
    "role_id": "456e7890-e89b-12d3-a456-426614174001",
    "valid_from": "2024-01-01",
    "valid_to": "2024-12-31",
    "is_primary": true
}
```

**Ответ (200):**
```json
{
    "id": "123e4567-e89b-12d3-a456-426614174000",
    "full_name": "Иван Иванов",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 123 45 67",
    "is_active": true,
    "roles": [
        {
            "id": "456e7890-e89b-12d3-a456-426614174001",
            "code": "EXECUTOR",
            "name": "Исполнитель"
        }
    ]
}
```

**Ошибки:**
- `404 Not Found` - Пользователь или роль не найдены
- `409 Conflict` - Пользователь уже имеет эту роль в указанном периоде

### Роли

#### 1. Получение списка ролей
**GET** `/api/roles`

Возвращает список всех ролей в системе.

**Ответ (200):**
```json
[
    {
        "id": "456e7890-e89b-12d3-a456-426614174001",
        "code": "EXECUTOR",
        "name": "Исполнитель"
    },
    {
        "id": "789e0123-e89b-12d3-a456-426614174002",
        "code": "ADMIN",
        "name": "Администратор"
    }
]
```

#### 2. Получение роли по ID
**GET** `/api/roles/{role_id}`

Возвращает данные роли по ID.

**Параметры:**
- `role_id` (UUID) - ID роли

**Ответ (200):**
```json
{
    "id": "456e7890-e89b-12d3-a456-426614174001",
    "code": "EXECUTOR",
    "name": "Исполнитель"
}
```

**Ошибки:**
- `404 Not Found` - Роль не найдена

#### 3. Создание роли
**POST** `/api/roles`

Создает новую роль в системе.

**Запрос:**
```json
{
    "code": "MANAGER",
    "name": "Менеджер"
}
```

**Ответ (201):**
```json
{
    "id": "789e0123-e89b-12d3-a456-426614174002",
    "code": "MANAGER",
    "name": "Менеджер"
}
```

**Ошибки:**
- `409 Conflict` - Код роли уже существует
- `422 Unprocessable Entity` - Ошибка валидации данных

#### 4. Обновление роли
**PUT** `/api/roles/{role_id}`

Обновляет данные роли.

**Параметры:**
- `role_id` (UUID) - ID роли

**Запрос:**
```json
{
    "code": "SENIOR_MANAGER",
    "name": "Старший менеджер"
}
```

**Ответ (200):**
```json
{
    "id": "789e0123-e89b-12d3-a456-426614174002",
    "code": "SENIOR_MANAGER",
    "name": "Старший менеджер"
}
```

**Ошибки:**
- `404 Not Found` - Роль не найдена
- `409 Conflict` - Новый код роли уже существует

#### 5. Удаление роли
**DELETE** `/api/roles/{role_id}`

Удаляет роль из системы.

**Параметры:**
- `role_id` (UUID) - ID роли

**Ответ (204):** Пустой ответ

**Ошибки:**
- `404 Not Found` - Роль не найдена
- `409 Conflict` - Роль назначена пользователям и не может быть удалена

## Бизнес-логика

### Валидация данных

1. **Email уникальность**: При создании и обновлении пользователя проверяется уникальность email адреса
2. **Код роли уникальность**: При создании и обновлении роли проверяется уникальность кода роли
3. **Период действия роли**: При назначении роли проверяется, что пользователь не имеет эту роль в перекрывающемся периоде
4. **Активные роли**: При получении пользователя с ролями возвращаются только активные роли (действующие на текущую дату)

### Безопасность

1. **Хеширование паролей**: Пароли пользователей хешируются перед сохранением в базу данных
2. **Валидация UUID**: Все ID параметры валидируются как корректные UUID
3. **Валидация email**: Email адреса валидируются на корректность формата

### Обработка ошибок

1. **404 Not Found**: Возвращается когда запрашиваемый ресурс не найден
2. **409 Conflict**: Возвращается при попытке создать дублирующий ресурс
3. **422 Unprocessable Entity**: Возвращается при ошибках валидации данных
4. **500 Internal Server Error**: Возвращается при внутренних ошибках сервера

## Примеры использования

### Создание пользователя с назначением роли

```bash
# 1. Создание пользователя
curl -X POST "http://localhost:8000/api/users" \
  -H "Content-Type: application/json" \
  -d '{
    "full_name": "Иван Иванов",
    "email": "ivan.ivanov@example.com",
    "phone": "+7 777 123 45 67",
    "password": "secure_password123"
  }'

# 2. Создание роли
curl -X POST "http://localhost:8000/api/roles" \
  -H "Content-Type: application/json" \
  -d '{
    "code": "EXECUTOR",
    "name": "Исполнитель"
  }'

# 3. Назначение роли пользователю
curl -X POST "http://localhost:8000/api/users/{user_id}/roles" \
  -H "Content-Type: application/json" \
  -d '{
    "role_id": "{role_id}",
    "valid_from": "2024-01-01",
    "valid_to": "2024-12-31",
    "is_primary": true
  }'
```

### Получение пользователя с ролями

```bash
curl -X GET "http://localhost:8000/api/users/{user_id}"
```

### Обновление данных пользователя

```bash
curl -X PUT "http://localhost:8000/api/users/{user_id}" \
  -H "Content-Type: application/json" \
  -d '{
    "full_name": "Иван Петров",
    "phone": "+7 777 987 65 43",
    "is_active": true
  }'
```

## Интеграция с системой

### Связь с другими модулями

1. **Payment Requests**: Пользователи создают и управляют заявками на оплату
2. **Registry**: Пользователи с ролью TREASURER управляют реестром платежей
3. **Files**: Пользователи загружают и управляют файлами

### Роли в системе

1. **EXECUTOR** - Исполнитель (создает заявки)
2. **REGISTRAR** - Регистратор (классифицирует заявки)
3. **DISTRIBUTOR** - Распределитель (проверяет контракты)
4. **TREASURER** - Казначей (управляет реестром)
5. **ADMIN** - Администратор (управляет системой)

## Мониторинг и логирование

### Рекомендуемые метрики

1. **Количество пользователей**: Общее количество и активных пользователей
2. **Распределение ролей**: Количество пользователей по ролям
3. **Активность пользователей**: Частота использования API
4. **Ошибки**: Количество и типы ошибок API

### Логирование

1. **Создание пользователей**: Логировать создание новых пользователей
2. **Назначение ролей**: Логировать изменения ролей пользователей
3. **Ошибки валидации**: Логировать ошибки валидации данных
4. **Системные ошибки**: Логировать внутренние ошибки сервера

## Развертывание и конфигурация

### Переменные окружения

```bash
# База данных
DATABASE_URL=postgresql://user:password@localhost/gc_spends

# Безопасность
SECRET_KEY=your-secret-key-here
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=30

# API
API_PREFIX=/api
```

### Зависимости

```txt
fastapi>=0.104.0
sqlalchemy>=2.0.0
pydantic>=2.0.0
python-multipart>=0.0.6
python-jose[cryptography]>=3.3.0
passlib[bcrypt]>=1.7.4
```

## Заключение

Сервис Users предоставляет полный функционал для управления пользователями и ролями в системе GC Spends. API спроектирован с учетом принципов REST и обеспечивает надежную валидацию данных, обработку ошибок и безопасность.

Сервис готов к использованию в продакшене и может быть легко расширен дополнительным функционалом по мере необходимости.
